name: UA E2E

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"  # ≈ 03:00 America/Toronto

permissions:
  contents: read

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Optionnel) Node.js si ton E2E en a besoin. Garde-le, ça ne gênera pas sinon.
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps (best effort)
        shell: bash
        run: |
          if [[ -f package-lock.json ]]; then npm ci || true; fi
          if [[ -f yarn.lock ]];         then yarn install --frozen-lockfile || true; fi
          if [[ -f pnpm-lock.yaml ]];    then corepack enable && pnpm i --frozen-lockfile || true; fi

      # (Exemple) Lancer tes E2E si tu as un script. Ajuste/active au besoin.
      - name: Run E2E (if script exists)
        shell: bash
        run: |
          if npm run | grep -q "e2e"; then npm run e2e || true; fi
          if [[ -f ./scripts/e2e.sh ]]; then bash ./scripts/e2e.sh || true; fi
        continue-on-error: true

      # Toujours uploader l’artifact, même si les tests échouent
      - name: Upload E2E results
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ua-e2e-results
          # Mets ici les dossiers/fichiers réellement produits par ton E2E
          path: |
            **/test-results/**
            **/playwright-report/**
            **/reports/**
            **/e2e/**/screenshots/**
            **/*.junit.xml
            **/*.trx
            **/*.html
            **/*.log
          if-no-files-found: warn
          retention-days: 7
# ⬇️ ajoute ces deux steps dans le job E2E, juste avant ton "Upload E2E results" actuel
- name: Prepare E2E bundle
  if: ${{ always() }}
  shell: bash
  run: |
    mkdir -p ua-e2e-out
    echo "{\"run_id\":\"${{ github.run_id }}\",\"ts\":\"$(date -Is)\"}" > ua-e2e-out/summary.json
    # si tu as déjà des rapports/logs, copie-les ici (exemples) :
    for d in test-results playwright-report reports; do
      if [ -d "$d" ]; then cp -R "$d" "ua-e2e-out/$d"; fi
    done

- name: Upload E2E results
  if: ${{ always() }}
  uses: actions/upload-artifact@v4
  with:
    name: ua-e2e-results
    path: |
      ua-e2e-out/**
    if-no-files-found: error
    retention-days: 7
