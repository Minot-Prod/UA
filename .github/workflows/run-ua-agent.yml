name: "🧠 UA Agent Runner"
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Simuler sans pousser les changements ?"
        required: false
        default: "false"
      branch:
        description: "Nom de la branche bootstrap"
        required: false
        default: "feat/ua-bootstrap"
      version:
        description: "Version de release"
        required: false
        default: "v0.1.0"

permissions:
  contents: write
  pull-requests: write

jobs:
  ua-bootstrap:
    name: "UA Full Bootstrap Execution"
    runs-on: ubuntu-latest

    steps:
      - name: "📥 Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "⚙️ Setup environment"
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git jq
          echo "✅ Git & jq installed."

      - name: "🔐 Configure GitHub CLI"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Authenticating gh CLI..."
          gh auth setup-git
          gh auth status

      - name: "🧠 Run UA Full Bootstrap Agent"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          BRANCH: ${{ github.event.inputs.branch }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          echo "🚀 Launching UA Full Bootstrap Agent..."
          bash .github/agents/UA_FULL_BOOTSTRAP.yaml || exit 1

      - name: "📊 Archive UA Report"
        if: always()
        run: |
          if [ -f UA_BOOTSTRAP_REPORT.json ]; then
            echo "UA Bootstrap completed. Summary:"
            cat UA_BOOTSTRAP_REPORT.json
          else
            echo "⚠️ Aucun rapport UA généré."
          fi

      - name: "🗃️ Upload Report Artifact"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: UA_BOOTSTRAP_REPORT
          path: UA_BOOTSTRAP_REPORT.json
